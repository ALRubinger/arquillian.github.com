<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Testing Java Persistence &#183; Arquillian Guides</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="Test your data! Learn how to test Java Persistence (JPA) queries against multiple providers in an Arquillian test." name="description" />
    <link href="/blog/atom.xml" rel="alternate" title="Arquillian blog Atom feed" type="application/atom+xml" />
    <link href="/stylesheets/screen.css?030468895361fa022c6b121c1ff226b64c2865e0" rel="stylesheet" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/r29/html5.js"></script>
    <![endif]-->
    <link href="/favicon.ico" rel="shortcut icon" />
  </head>
  <body class="guide">
    <header class="navbar navbar-fixed-top" id="banner" role="banner">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/">
            <span class="logo"></span>
            <span class="name">Arquillian</span>
          </a>
          <nav class="nav-collapse" role="navigation">
            <ul class="nav">
              <li><a href="/invasion/">Invasion!</a></li>
              <li><a href="/features/">Features</a></li>
              <li class="active"><a href="/guides/">Guides</a></li>
              <li><a href="/blog/">Blog</a></li>
              <li><a href="/community/">Community</a></li>
              <li><a href="/code/">Code</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </header>
    <div id="main" role="main">
      <div id="content-header">
        <div class="container">
          <div class="headline">
            <h1>
              <a href="/guides/">Arquillian Guides</a>
              <small>Designed exclusively to teach you how to use Arquillian to write real tests.</small>
            </h1>
            <div class="directory">
              <a class="guides_menu" href="./" id="guides_menu">
                Guides Index
                <span class="arrow">&rsaquo;</span>
              </a>
              <div id="guides" style="display: none">
                <a class="guides_menu" href="./">
                  Guides Index
                  <span class="arrow">&rsaquo;</span>
                </a>
                <hr class="clear" />
                <dl class="beg">
                  <dt>First Steps</dt>
                  <dd><a href="/guides/getting_started/">Getting Started</a>
                  <br />
                  <a href="/guides/getting_started/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/getting_started_de/"><img class="flag" rel="tooltip" src="/images/flags/de.png" title="Deutsch (de)" /></a>
                  <a href="/guides/getting_started_es/"><img class="flag" rel="tooltip" src="/images/flags/es.png" title="Español (es)" /></a>
                  <a href="/guides/getting_started_fr/"><img class="flag" rel="tooltip" src="/images/flags/fr.png" title="Française (fr)" /></a>
                  <a href="/guides/getting_started_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/getting_started_nl/"><img class="flag" rel="tooltip" src="/images/flags/nl.png" title="Nederlands (nl)" /></a>
                  <a href="/guides/getting_started_pl/"><img class="flag" rel="tooltip" src="/images/flags/pl.png" title="Polski (pl)" /></a>
                  <a href="/guides/getting_started_pt/"><img class="flag" rel="tooltip" src="/images/flags/pt.png" title="Português (pt)" /></a>
                  <a href="/guides/getting_started_sv_se/"><img class="flag" rel="tooltip" src="/images/flags/sv_se.png" title="Svenska (sv_se)" /></a>
                  <a href="/guides/getting_started_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                  <dd><a href="/guides/getting_started_rinse_and_repeat/">Getting Started: Rinse and Repeat</a>
                  <br />
                  <a href="/guides/getting_started_rinse_and_repeat/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/getting_started_rinse_and_repeat_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                  <dd><a href="/guides/get_started_faster_with_forge/">Get Started Faster with Forge</a>
                  <br />
                  <a href="/guides/get_started_faster_with_forge/"><img class="flag" rel="tooltip" src="/images/flags/en.png" title="English (en)" /></a>
                  <a href="/guides/get_started_faster_with_forge_ja/"><img class="flag" rel="tooltip" src="/images/flags/ja.png" title="日本 (ja)" /></a>
                  <a href="/guides/get_started_faster_with_forge_zh_cn/"><img class="flag" rel="tooltip" src="/images/flags/zh_cn.png" title="简体中文 (zh_cn)" /></a></dd>
                  <dd><a href="/guides/shrinkwrap_introduction/">Creating Deployable Archives with ShrinkWrap</a></dd>
                </dl>
                <dl class="int">
                  <dt>More Coverage</dt>
                  <dd><a href="/guides/testing_java_persistence/">Testing Java Persistence</a></dd>
                  <dd><a href="/guides/functional_testing_using_drone/">Functional Testing using Drone</a></dd>
                </dl>
                <dl class="adv">
                  <dt>Enhance</dt>
                  <dd><a href="/guides/testing_in_the_cloud/">Testing in the Cloud</a></dd>
                </dl>
                <dl class="ref">
                  <dt>Reference</dt>
                  <dd><a href="https://docs.jboss.org/author/display/ARQ/Reference+Guide">Reference Guide</a></dd>
                  <dd><a href="http://docs.jboss.org/arquillian/api/latest">API Docs</a>,
                  <a href="http://docs.jboss.org/arquillian/spi/latest">SPI Docs</a></dd>
                  <dd><a href="http://community.jboss.org/wiki/ArquillianMigrationGuides">Migration Guides</a></dd>
                  <dd><a href="http://community.jboss.org/en/arquillian/faq">FAQs</a></dd>
                </dl>
              </div>
            </div>
            <script>$(function() { activateGuideMenuControl() })</script>
          </div>
        </div>
      </div>
      <div class="container" id="guide">
        <div id="content">
            <div class="header">
            <h2>Testing Java Persistence</h2>
            <div class="authors"><strong>Authors:</strong>
           <a href="https://community.jboss.org/people/dan.j.allen">Dan Allen</a>, <a href="https://community.jboss.org/people/bmajsak">Bartosz Majsak</a>
          <br />
          <strong>Level:</strong>
           More Coverage
          <strong style="padding-left: 10px;">Tags:</strong>
           jpa, database, persistence, transactions
          <strong style="padding-left: 10px;">Last Update:</strong> Apr 05, 2012</div>
            <p>This guide teaches you how to use Arquillian to test Java Persistence (JPA). After reading this guide, you&#8217;ll be able to:</p>
            <ul>
          	<li>Create a test archive that includes the JPA descriptor (persistence.xml)</li>
          	<li>Inject the EntityManager and UserTransaction into your test</li>
          	<li>Persist entities then subsequently query them via JPQL and the Criteria API (JPA 2)</li>
          	<li>Execute the tests using different JPA providers</li>
          </ul>
            <p>You&#8217;ll soon discover that Arquillian offers the perfect recipe for testing JPA or to simply experiment with how it works. We&#8217;ve designed this guide to be easy to follow so that you can come back to it whenever you need to hammer on JPA.</p>
            </div>
            <h3 id="assumptions">Assumptions</h3>
          <p>We&#8217;ll assume that you&#8217;ve read the <a href="/guides/getting_started">Getting Started</a> guide and have an Arquillian test suite setup in your project. We&#8217;ll be adding a JPA entity to the project to create a basic Java persistence test (JPA). From there, you can apply these instructions to any other entities you need to test.</p>
          <p>The instructions in this guide are specific to a Maven project, though remember that Arquillian is not tied to Maven in any way. We&#8217;ll be running the tests iin Embedded GlassFish and a standalone JBoss AS 6 instance, though you can use any container supported by Arquillian that supports JPA.</p>
          <h3 id="purpose">Purpose</h3>
          <p>The application has a (video) <code>Game</code> entity with two fields:</p>
          <ul>
          	<li><code>id</code> &#8211; the primary key</li>
          	<li><code>title</code> &#8211; the title of the game</li>
          </ul>
          <p>We&#8217;ll be writing a test that persists sample entries to the database and then retrieves them using a JPQL statement and also the Criteria API (from JPA 2). To review, the test will perform these three tasks:</p>
          <ul>
          	<li>store sample entities in the database using the JPA <code>EntityManager</code></li>
          	<li>query the database using JPQL</li>
          	<li>query the database using Criteria API</li>
          </ul>
          <p>The entire source code is available in the <a href="http://github.com/arquillian/arquillian-examples/tree/master/jpa2">Arquillian examples project</a> on github.  All you need to see the action is run &#8220;mvn test&#8221; (and a hint of patience to wait for Maven to download the dependencies).</p>
          <h3 id="project_structure">Project Structure</h3>
          <p>To get you acclimated, here&#8217;s the directory structure of the project:</p>
          <ul class="filetree">
          	<li>src/
          	<ul>
          		<li>main/
          		<ul>
          			<li>java/
          			<ul>
          				<li>org/
          				<ul>
          					<li>arquillian/
          					<ul>
          						<li>example/
          						<ul>
          							<li>Game.java</li>
          						</ul></li>
          					</ul></li>
          				</ul></li>
          			</ul></li>
          		</ul></li>
          		<li>test/
          		<ul>
          			<li>java/
          			<ul>
          				<li>org/
          				<ul>
          					<li>arquillian/
          					<ul>
          						<li>example/
          						<ul>
          							<li>GamePersistenceTest.java</li>
          						</ul></li>
          					</ul></li>
          				</ul></li>
          			</ul></li>
          			<li>resources/
          			<ul>
          				<li>arquillian.xml</li>
          			</ul></li>
          			<li>resources-glassfish-embedded/
          			<ul>
          				<li>glassfish-resources.xml</li>
          				<li>test-persistence.xml</li>
          			</ul></li>
          			<li>resources-jbossas-remote/
          			<ul>
          				<li>test-persistence.xml</li>
          			</ul></li>
          		</ul></li>
          	</ul></li>
          	<li>pom.xml</li>
          </ul>
          <p><code>Game</code> is the JPA entity class and test-persistence.xml provides the definition of our Persistence Unit for the test environment. Notice there are two folders containing a test-persistence.xml file, one for each container we&#8217;ll be using. We&#8217;ll get to that later. We&#8217;ll leave persistence.xml alone since that&#8217;s the definition for the production environment.</p>
          <p>Here&#8217;s the source of the <code>Game</code> entity class, as denoted by the <code>@Entity</code> annotation:</p>
          <div class="filename">src/main/resources/org/arquillian/example/Game.java</div>
          <pre class="prettify"><code class="prettify">package org.arquillian.example</code>
           
          <code class="prettify">import java.io.Serializable;
          import javax.persistence.Entity;
          import javax.persistence.GeneratedValue;
          import javax.persistence.Id;
          import javax.validation.constraints.NotNull;
          import javax.validation.constraints.Size;</code>
           
          <code class="prettify">@Entity
          public class Game implements Serializable {
              private Long id;
              private String title;</code>
           
          <code class="prettify">    public Game() {}</code>
           
          <code class="prettify">    public Game(String title) {
                  this.title = title;
              }</code>
           
          <code class="prettify">    @Id @GeneratedValue
              public Long getId() {
                  return id;
              }</code>
           
          <code class="prettify">    public void setId(Long id) {
                  this.id = id;
              }</code>
           
          <code class="prettify">    @NotNull
              @Size(min = 3, max = 50)
              public String getTitle() {
                  return title;
              }</code>
           
          <code class="prettify">    public void setTitle(String name) {
                  this.title = name;
              }</code>
           
          <code class="prettify">    @Override
              public String toString() {
                  return "Game@" + hashCode() +
                      "[id = " + id + "; title = " + title + "]";
              }
          }</code></pre>
          <p>The primary key is defined using the <code>@Id</code> annotation on the field. Additional columns are derived automatically from bean properties (standard getter/setter convention). You can use the <code>@Column</code> annotation to explicitly set the name of the column. Otherwise, the column name is determined by removing the &#8220;get&#8221; prefix from the bean property&#8217;s read method and lowercasing the first character of the remainder (e.g., getTitle() =&gt; title).</p>
          <p>We are also using standard Bean Validation annotations to enforce constraints. Here, a title must be provided and it must be between 3 and 50 characters long. That would make a good test.</p>
          <h3 id="write_the_test">Write the Test</h3>
          <p>Speaking of tests, let&#8217;s create a new JUnit 4 Arquillian test case, <code>GamePersistenceTest</code>, and prepare it to test our JPA operations. We&#8217;ll leverage <a href="http://docs.jboss.org/cdi/spec/1.0/html" title="JSR-299">CDI</a> to supply us with the resources we need via dependency injection. (Alternatively, you could use a utility EJB to handle the transaction boundaries, which we&#8217;ll visit in a seperate guide).</p>
          <div class="filename">src/test/java/org/arquillian/example/GamePersistenceTest.java</div>
          <pre class="prettify"><code class="prettify">package org.arquillian.example;</code>
          
          <code class="prettify">import java.util.List;</code>
          
          <code class="prettify">import javax.inject.Inject;
          import javax.persistence.EntityManager;
          import javax.persistence.PersistenceContext;
          import javax.persistence.criteria.CriteriaBuilder;
          import javax.persistence.criteria.CriteriaQuery;
          import javax.persistence.criteria.Root;
          import javax.transaction.UserTransaction;</code>
          
          <code class="prettify">import org.jboss.arquillian.container.test.api.Deployment;
          import org.jboss.arquillian.junit.Arquillian;
          import org.jboss.shrinkwrap.api.ShrinkWrap;
          import org.jboss.shrinkwrap.api.asset.EmptyAsset;
          import org.jboss.shrinkwrap.api.spec.WebArchive;
          import org.junit.Assert;
          import org.junit.Before;
          import org.junit.Test;
          import org.junit.runner.RunWith;</code>
          
          <code class="prettify">@RunWith(Arquillian.class)
          public class GamePersistenceTest {
              @Deployment
              public static Archive&lt;?&gt; createDeployment() {
                  return ShrinkWrap.create(WebArchive.class, "test.war")
                      .addPackage(Game.class.getPackage())
                      .addAsResource("test-persistence.xml", "META-INF/persistence.xml")
                      .addAsWebResource(EmptyAsset.INSTANCE, "beans.xml");
              }</code>
           
          <code class="prettify">    private static final String[] GAME_TITLES = {
                  "Super Mario Brothers",
                  "Mario Kart",
                  "F-Zero"
              };</code>
              
          <code class="prettify">    @PersistenceContext
              EntityManager em;</code>
              
          <code class="prettify">    @Inject
              UserTransaction utx;</code>
           
          <code class="prettify">    // tests go here
          }</code></pre>
          <p>Let&#8217;s work from top to bottom to understand what&#8217;s going on here before we get to the tests.</p>
          <dl>
          	<dt>@RunWith(Arquillian.class)</dt>
          	<dd>Tells JUnit to delegate execution of the test to the Arquillian runner.  This allows Arquillian to infuse your test with a component model, which consists of container lifecycle management and dependency injection, among other enhancements. Notice that you are not required to extend a base class, so that&#8217;s left open to your own design.</dd>
          	<dt>@Deployment method</dt>
          	<dd>Produces a &#8220;micro deployment&#8221; archive using the ShrinkWrap API.  Arquillian deploys this archive, along with the test case and some additional infrastructure, to the container. The test then executes as a component within this mini application. The contents of this archive are the tests isolated little world.</dd>
          	<dt>GAME_TITLES constant</dt>
          	<dd>The sample test data</dd>
          	<dt>PersistenceContext EntityManager</dt>
          	<dd>Injects the persistence context (<code>EntityManager</code>) directly into the test, just as though the test were a <a href="http://download.oracle.com/javaee/6/api/javax/annotation/ManagedBean.html">managed bean</a>.</dd>
          	<dt>@Inject UserTransaction</dt>
          	<dd>Injects a JTA transaction directly into the test, a service provided to the managed bean by CDI (JSR-299).</dd>
          </dl>
          <p>To not clutter test&#8217;s logic with persistence-related setup let&#8217;s introduce intercepting methods which will be triggered before and after each test&#8217;s execution. Let&#8217;s have a look at this cross-cutting code.</p>
          <p>Method invoked before test should have following responsibilites:</p>
          <ul>
          	<li>Clean database state to avoid leftovers from previous test execution.</li>
          	<li>Insert test data used by the test itself.</li>
          	<li>Start the transaction.</li>
          </ul>
          <pre class="prettify"><code class="prettify">@Before
          public void preparePersistenceTest() throws Exception {
              clearDatabase();
              insertData();
              startTransaction();
          }</code>
          
          <code class="prettify">private void clearDatabase() throws Exception {
              utx.begin();
              em.joinTransaction();
              em.createQuery("delete from Game").executeUpdate();
              utx.commit();
          }</code>
          
          <code class="prettify">private void insertData() throws Exception {
              utx.begin();
              em.joinTransaction();
              for (String title : GAME_TITLES) {
                  Game game = new Game(title);
                  em.persist(game);
              }
              utx.commit();
          }</code>
          
          <code class="prettify">private void startTransaction() throws Exception {
              utx.begin();
              em.joinTransaction();
          }</code></pre>
          <p>What we need to add after each test is to simply commit the transaction.</p>
          <pre class="prettify"><code class="prettify">@After
          public void commitTransaction() throws Exception {
              utx.commit();
          }</code></pre>
          <p>Arquillian executes the <code>@Before</code> and <code>@After</code> methods in-container after the injections have occurred but still before/after each test method is executed.</p>
          <p class="important"><span>When using TestNG, the <code>@Before</code> method <em>does not</em> get executed in-container by Arquillian. This feature only works with JUnit. See issue <a href="https://issues.jboss.org/browse/ARQ-56">ARQ-56</a>.</span></p>
          <p>Notice we have to explicitly enlist the <code>EntityManager</code> in the JTA transaction. This step is necessary since we are using the two resources independently. This may look abnormal if you&#8217;re used to using JPA from within an EJB, where enlistment happens automatically.</p>
          <p>Here&#8217;s the test that verifies we can select the sample records using JPQL.  We&#8217;ll print some logging statements so you can watch what&#8217;s going on.</p>
          <pre class="prettify"><code class="prettify">@Test
          public void shouldFindAllGamesUsingJpqlQuery() throws Exception {
              // given
              String fetchingAllGamesInJpql = "select g from Game g order by g.id";</code>
          
          <code class="prettify">    // when
              System.out.println("Selecting (using JPQL)...");
              List&lt;Game&gt; games = em.createQuery(fetchingAllGamesInJpql, Game.class).getResultList();</code>
          
          <code class="prettify">    // then
              System.out.println("Found " + games.size() + " games (using JPQL)");
              assertContainsAllGames(games);
          }</code></pre>
          <p>You might have noticed <code>assertContainsAllGames</code> method which is a custom assertion verifying that returned collection contains all titles stored in the database. It gives two benefits for our testing logic &#8211; it clearly explains what we are expecting and it can be reused in other tests.</p>
          <pre class="prettify"><code class="prettify">private static void assertContainsAllGames(Collection&lt;Game&gt; retrievedGames) {
              assertEquals(GAME_TITLES.length, retrievedGames.size());
              final Set&lt;String&gt; retrievedGameTitles = new HashSet&lt;String&gt;();
              for (Game game : retrievedGames) {
                  retrievedGameTitles.add(game.getTitle());
              }
              assertTrue(retrievedGameTitles.containsAll(Arrays.asList(GAME_TITLES)));
          }</code></pre>
          <p>Now for the new JPA 2 stuff! Here&#8217;s the same test that uses the Criteria API. Note that this test depends on the JPA 2 annotation processor generating the <code>Game_</code> metamodel class during the build compilation step.</p>
          <pre class="prettify"><code class="prettify">@Test
          public void shouldFindAllGamesUsingCriteriaApi() throws Exception {
              // given
              CriteriaBuilder builder = em.getCriteriaBuilder();
              CriteriaQuery&lt;Game&gt; criteria = builder.createQuery(Game.class);</code>
              		
          <code class="prettify">    Root&lt;Game&gt; game = criteria.from(Game.class);
              criteria.select(game);
              criteria.orderBy(builder.asc(game.get("id")));
              // No WHERE clause, which implies select all</code>
          
          <code class="prettify">    // when
              System.out.println("Selecting (using Criteria)...");
              List&lt;Game&gt; games = em.createQuery(criteria).getResultList();</code>
          
          <code class="prettify">    // then
              System.out.println("Found " + games.size() + " games (using Criteria)");
              assertContainsAllGames(games);
          }</code></pre>
          <p>In order for JPA to work, it needs a Persistence Unit. We define the Persistence Unit in the test-persistence.xml that&#8217;s associated with the target container.</p>
          <p>ShrinkWrap takes this file from the classpath and puts it into its standard location within the archive.</p>
          <pre class="prettify"><code class="prettify">.addAsResource("test-persistence.xml", "META-INF/persistence.xml")</code></pre>
          <p>Here&#8217;s the entire structure of the archive ShrinkWrap will assemble for this test case (minus the Arquillian infrastructure):</p>
          <ul>
          	<li>WEB-INF/
          	<ul>
          		<li>beans.xml</li>
          		<li>classes/
          		<ul>
          			<li>META-INF/
          			<ul>
          				<li>persistence.xml</li>
          			</ul></li>
          			<li>org/
          			<ul>
          				<li>arquillian/
          				<ul>
          					<li>example/
          					<ul>
          						<li>Game.class</li>
          						<li>GamePersistenceTestCase.class</li>
          						<li>Game_.class</li>
          					</ul></li>
          				</ul></li>
          			</ul></li>
          		</ul></li>
          		<li>lib/
          		<ul>
          			<li>*.jar</li>
          		</ul></li>
          	</ul></li>
          </ul>
          <p>Let&#8217;s look at the Persistence Unit descriptor we&#8217;ll be using in the test, starting with the one for Embedded GlassFish.</p>
          <h3 id="setup_persistence">Setup Persistence</h3>
          <p>Here&#8217;s the Persistence Unit descriptor we&#8217;ll be using for Embedded GlassFish:</p>
          <div class="filename">src/test/resources-glassfish-embedded/test-persistence.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
          &lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="
                  http://java.sun.com/xml/ns/persistence
                  http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;
              &lt;persistence-unit name="test"&gt;
                  &lt;jta-data-source&gt;jdbc/arquillian&lt;/jta-data-source&gt;
                  &lt;properties&gt;
                      &lt;property name="eclipselink.ddl-generation"
                          value="drop-and-create-tables"/&gt;
                      &lt;property name="eclipselink.logging.level" value="FINE"/&gt;
                  &lt;/properties&gt;
              &lt;/persistence-unit&gt;
          &lt;/persistence&gt;</code></pre>
          <p>We set two vendor-specific properties to activate features of the built-in provider, EclipseLink. The first property tells EclipseLink to generate the database to match the JPA entities. The second property enables logging of SQL statements so we can monitor the activity.</p>
          <p>The Persistence Unit is referring to the JTA DataSource named jdbc/arquillian.  Where&#8217;s that defined? Ah, that&#8217;s something the Arquillian container adapter needs to setup. As in Arun&#8217;s recipe, we want to use the GlassFish APIs to create a JDBC Connection Pool and associated Resource. But we don&#8217;t want to have to code it. We just want to declare it.</p>
          <p>First, we create a glassfish-resources.xml file containing the resource definitions, which GlassFish knows how to consume.</p>
          <div class="filename">src/test/resources-glassfish-embedded/glassfish-resources.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
          &lt;!DOCTYPE resources PUBLIC
              "-//GlassFish.org//DTD GlassFish Application Server 3.1 Resource Definitions//EN"
              "http://glassfish.org/dtds/glassfish-resources_1_5.dtd"&gt;
          &lt;resources&gt;
              &lt;jdbc-resource pool-name="ArquillianEmbeddedDerbyPool"
                  jndi-name="jdbc/arquillian"/&gt;
              &lt;jdbc-connection-pool name="ArquillianEmbeddedDerbyPool"
                  res-type="javax.sql.DataSource"
                  datasource-classname="org.apache.derby.jdbc.EmbeddedDataSource"
                  is-isolation-level-guaranteed="false"&gt;
                  &lt;property name="databaseName" value="target/databases/derby"/&gt;
                  &lt;property name="createDatabase" value="create"/&gt;
              &lt;/jdbc-connection-pool&gt;
          &lt;/resources&gt;</code></pre>
          <p>We&#8217;ve now isolated the DataSource definition from the test in the same way we do in the main application. The further benefit is that we can define any resources we might need for our test. Imagine the possibilities.</p>
          <p>Now we need to tell Arquillian to use this file. We open up the Arquillian configuration and configure the Embedded GlassFish container adapter to pick up this file, which it will feed to the asadmin add-resources command.</p>
          <div class="filename">src/test/resources/arquillian.xml</div>
          <pre class="prettify"><code class="prettify">&lt;arquillian xmlns="http://jboss.org/schema/arquillian"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="
                  http://jboss.org/schema/arquillian
                  http://jboss.org/schema/arquillian/arquillian_1_0.xsd"&gt;
              &lt;container qualifier="glassfish-embedded" default="true"&gt;
                  &lt;configuration&gt;
                      &lt;property name="sunResourcesXml"&gt;
                          src/test/resources-glassfish-embedded/glassfish-resources.xml
                      &lt;/property&gt;
                  &lt;/configuration&gt;
              &lt;/container&gt;
          &lt;/arquillian&gt;</code>
          
          <code class="prettify">All that's left is to setup the Maven build to execute the test.</code></pre>
          <h3 id="prep_the_test_glassfish">Prep the Test (GlassFish)</h3>
          <p>To get this code to compile, we have to tell Maven it&#8217;s okay to use JDK 6 (it&#8217;s stubborn like that).</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;
          &lt;build&gt;
              &lt;plugins&gt;
                  &lt;plugin&gt;
                      &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                      &lt;version&gt;2.3.1&lt;/version&gt;
                      &lt;configuration&gt;
                          &lt;source&gt;1.6&lt;/source&gt;
                          &lt;target&gt;1.6&lt;/target&gt;
                      &lt;/configuration&gt;
                  &lt;/plugin&gt;
              &lt;/plugins&gt;
          &lt;/build&gt;
          &lt;!-- clip --&gt;</code></pre>
          <p>You also need to configure Maven to run the JPA 2 annotation processor, which is done by adding the Hibernate JPA metamodel generator as a project dependency:</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;
          &lt;dependency&gt;
              &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
              &lt;artifactId&gt;hibernate-jpamodelgen&lt;/artifactId&gt;
              &lt;version&gt;1.1.1.Final&lt;/version&gt;
              &lt;scope&gt;provided&lt;/scope&gt;
          &lt;/dependency&gt;
          &lt;!-- clip --&gt;</code></pre>
          <p>We&#8217;re going to separate out the target containers using Maven profiles. All of the profiles will share a common set of dependencies:</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;
          &lt;dependencyManagement&gt;
              &lt;dependencies&gt;
                  &lt;dependency&gt;
                      &lt;groupId&gt;org.jboss.arquillian&lt;/groupId&gt;
                      &lt;artifactId&gt;arquillian-bom&lt;/artifactId&gt;
                      &lt;version&gt;1.0.0.CR5&lt;/version&gt;
                      &lt;scope&gt;import&lt;/scope&gt;
                      &lt;type&gt;pom&lt;/type&gt;
                  &lt;/dependency&gt;
              &lt;/dependencies&gt;
          &lt;/dependencyManagement&gt;
          &lt;dependencies&gt;
              &lt;dependency&gt;
                  &lt;groupId&gt;junit&lt;/groupId&gt;
                  &lt;artifactId&gt;junit&lt;/artifactId&gt;
                  &lt;version&gt;4.8.1&lt;/version&gt;
              &lt;/dependency&gt;
              &lt;dependency&gt;
                  &lt;groupId&gt;org.jboss.arquillian.junit&lt;/groupId&gt;
                  &lt;artifactId&gt;arquillian-junit-container&lt;/artifactId&gt;
                  &lt;scope&gt;test&lt;/scope&gt;
              &lt;/dependency&gt;
          &lt;/dependencies&gt;
          &lt;!-- clip --&gt;</code></pre>
          <p>Here&#8217;s the profile for Embedded GlassFish. If you don&#8217;t want to target multiple containers, you can simply make this part of the top-level configuration.</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;
          &lt;profile&gt;
              &lt;id&gt;arquillian-glassfish-embedded&lt;/id&gt;
              &lt;activation&gt;
                  &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;
              &lt;/activation&gt;
              &lt;dependencies&gt;
                  &lt;dependency&gt;
                      &lt;groupId&gt;org.jboss.arquillian.container&lt;/groupId&gt;
                      &lt;artifactId&gt;arquillian-glassfish-embedded-3.1&lt;/artifactId&gt;
                      &lt;version&gt;1.0.0.CR2&lt;/version&gt;
                  &lt;/dependency&gt;
                  &lt;dependency&gt;
                      &lt;groupId&gt;org.glassfish.main.extras&lt;/groupId&gt;
                      &lt;artifactId&gt;glassfish-embedded-all&lt;/artifactId&gt;
                      &lt;version&gt;3.1.2&lt;/version&gt;
                  &lt;/dependency&gt;
              &lt;/dependencies&gt;
              &lt;build&gt;
                  &lt;testResources&gt;
                      &lt;testResource&gt;
                          &lt;directory&gt;src/test/resources&lt;/directory&gt;
                      &lt;/testResource&gt;
                      &lt;testResource&gt;
                          &lt;directory&gt;src/test/resources-glassfish-embedded&lt;/directory&gt;
                      &lt;/testResource&gt;
                  &lt;/testResources&gt;
              &lt;/build&gt;
          &lt;/profile&gt;
          &lt;!-- clip --&gt;</code></pre>
          <p>We are explicitly adding the src/test/resources-glassfish-embedded directory as a test resource directory so that test-persistence.xml is placed into the classpath. Again, if you only intend on using Embedded GlassFish, this file can be moved into the standard Maven location and you can skip this configuration.</p>
          <h3 id="run_the_test">Run the Test</h3>
          <p>When you are done setting everything up, you can run the test with the following command:</p>
          <pre class="command"><code class="command">$ mvn clean test</code></pre>
          <p>The profile for Embedded GlassFish is activated by default. Snippets of the test output is show below.</p>
          <pre class="output"><code class="output">...
          INFO: GlassFish Server Open Source Edition 3.1.1 (java_re-private)
          ...
          org.jboss.arquillian.container.glassfish.embedded_3.GlassFishEmbeddedContainer executeCommand
          INFO: add-resources command result (1): JDBC connection pool ArquillianEmbeddedDerbyPool created successfully.
          org.jboss.arquillian.container.glassfish.embedded_3.GlassFishEmbeddedContainer executeCommand
          INFO: add-resources command result (2): JDBC resource jdbc/arquillian created successfully.
          com.sun.enterprise.v3.services.impl.GrizzlyProxy$2$1 onReady
          INFO: Grizzly Framework 1.9.18-o started in: 226ms listening on port 8181
          ...
          com.sun.enterprise.web.WebApplication start
          INFO: Loading application test at /test
          ...
          Inserting records...
          Selecting (using JPQL)...
          Found 3 games (using JPQL)
          Game@22609264[id = 1; title = Super Mario Brothers]
          Game@3655662[id = 2; title = Mario Kart]
          Game@20289248[id = 3; title = F-Zero]
          Selecting (using Criteria)...
          Found 3 games (using Criteria)
          Game@25589884[id = 1; title = Super Mario Brothers]
          Game@18616220[id = 2; title = Mario Kart]
          Game@29940830[id = 3; title = F-Zero]
          ...
          com.sun.enterprise.v3.server.AppServerStartup stop
          INFO: Shutdown procedure finished</code></pre>
          <p><strong>Congratulations!</strong> <strong class="greenbar">Green bar</strong>! <strong>Now that&#8217;s a real integration test!</strong></p>
          <h3 id="run_the_test_jboss_as">Run the Test (JBoss AS)</h3>
          <p>We can run the exact same test on JBoss AS. We&#8217;ll need a different Persistence Unit definition that specifies a JDBC Resource available on JBoss AS and sets some Hibernate configuration settings. (Arquillian doesn&#8217;t yet support deploying a DataSource to JBoss AS&#8212;though it&#8217;s in the pipeline&#8212;so for now we use the built-in DataSource, java:/DefaultDS.).</p>
          <div class="filename">src/test/resources-jbossas-remote/test-persistence.xml</div>
          <pre class="prettify"><code class="prettify">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
          &lt;persistence version="2.0" xmlns="http://java.sun.com/xml/ns/persistence"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="
                  http://java.sun.com/xml/ns/persistence
                  http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;
              &lt;persistence-unit name="test"&gt;
                  &lt;jta-data-source&gt;java:/DefaultDS&lt;/jta-data-source&gt;
                  &lt;properties&gt;
                      &lt;property name="hibernate.hbm2ddl.auto" value="create-drop"/&gt;
                      &lt;property name="hibernate.show_sql" value="true"/&gt;
                  &lt;/properties&gt;
              &lt;/persistence-unit&gt;
          &lt;/persistence&gt;</code></pre>
          <p>Then we need a Maven profile that adds the JBoss AS container adapter and client API libraries and the JBoss AS resources:</p>
          <div class="filename">pom.xml</div>
          <pre class="prettify"><code class="prettify">&lt;!-- clip --&gt;
          &lt;profile&gt;
              &lt;id&gt;arquillian-jbossas-managed&lt;/id&gt;
              &lt;dependencies&gt;
                  &lt;dependency&gt;
                      &lt;groupId&gt;org.jboss.arquillian.container&lt;/groupId&gt;
                      &lt;artifactId&gt;arquillian-jbossas-managed-6&lt;/artifactId&gt;
                      &lt;version&gt;1.0.0.CR1&lt;/version&gt;
                  &lt;/dependency&gt;
                  &lt;dependency&gt;
                      &lt;groupId&gt;org.jboss.jbossas&lt;/groupId&gt;
                      &lt;artifactId&gt;jboss-as-client&lt;/artifactId&gt;
                      &lt;version&gt;6.0.0.Final&lt;/version&gt;
                      &lt;type&gt;pom&lt;/type&gt;
                      &lt;scope&gt;provided&lt;/scope&gt;
                  &lt;/dependency&gt;
                  &lt;dependency&gt;
                      &lt;groupId&gt;org.jboss.spec&lt;/groupId&gt;
                      &lt;artifactId&gt;jboss-javaee-6.0&lt;/artifactId&gt;
                      &lt;version&gt;1.0.0.Final&lt;/version&gt;
                      &lt;type&gt;pom&lt;/type&gt;
                      &lt;scope&gt;provided&lt;/scope&gt;
                  &lt;/dependency&gt;
                  &lt;dependency&gt;
                      &lt;groupId&gt;org.jboss.jbossas&lt;/groupId&gt;
                      &lt;artifactId&gt;jboss-server-manager&lt;/artifactId&gt;
                      &lt;version&gt;1.0.4.Final&lt;/version&gt;
                      &lt;scope&gt;test&lt;/scope&gt;
                  &lt;/dependency&gt;
              &lt;/dependencies&gt;
              &lt;build&gt;
                  &lt;testResources&gt;
                      &lt;testResource&gt;
                          &lt;directory&gt;src/test/resources&lt;/directory&gt;
                      &lt;/testResource&gt;
                      &lt;testResource&gt;
                          &lt;directory&gt;src/test/resources-jbossas-remote&lt;/directory&gt;
                      &lt;/testResource&gt;
                  &lt;/testResources&gt;
              &lt;/build&gt;
          &lt;/profile&gt;
          &lt;!-- clip --&gt;</code></pre>
          <p>Now we run the test again using Maven, but this time activate the JBoss AS managed profile. (You need to set the JBOSS_HOME environment variable to point to a JBoss AS installation)</p>
          <pre class="command"><code class="command">$ mvn clean test -Parquillian-jbossas-managed</code></pre>
          <p>Here&#8217;s the kicker. You can run this test into your IDE! Just import the project, open the test case and select &#8220;Run As &gt; JUnit Test&#8221;. Voila! It works just like any other JUnit test. <strong class="greenbar">Green bar</strong>!</p>
          <p><strong>Enjoy the perfect recipe for testing JPA!</strong></p>
          <p class="info"><span>While it may have seemed like a lot of preparation, recognize that we left no stone unturned. To remind you of the benefits, just look back at how simple the test case is. And remind yourself it&#8217;s not bound to any particular Java EE 6 container or JPA 2 implementation.</span></p>
          <h3 id="share">Share the Knowledge</h3>
          <p>Find this guide useful?</p>
          <p class="post_to_twitter"><a href="http://twitter.com/home/?status=Just%20read%20the%20%23Arquillian%20Testing%20Java%20Persistence%20guide%20and%20got%20a%20%23greenbar!%20Get%20yours.%20http://arquillian.org/guides/testing_java_persistence/"><img src="/images/post_to_twitter.png" alt="" /></a></p>
          <div class="g-plusone" data-size="tall"></div>
          <p>There&#8217;s a lot more about Arquillian to cover. If you&#8217;re ready to learn more, check out the <a href="/guides">other available guides</a>.</p>
          <h4>Feedback</h4>
          <p>Find a bug in the guide? Something missing? You can fix it by <a href="http://github.com/arquillian/arquillian.github.com">forking this website</a>, making the correction and <a href="http://help.github.com/send-pull-requests">sending a pull request</a>. If you&#8217;re just plain stuck, feel free to ask a question in the <a href="http://community.jboss.org/en/arquillian?view=discussions">user discussion forum</a>.</p>
          <h4>Recent Changelog</h4>
          <ul>
            <li>
              Apr 05, 2012:
              Use description in prolog for guide summary
              <em>by Dan Allen</em>
            </li>
            <li>
              Mar 12, 2012:
              Update glassfish-embedded-all version and groupid
              <em>by Dan Allen</em>
            </li>
            <li>
              Feb 10, 2012:
              Identify authors &amp; translators by site identity
              <em>by Dan Allen</em>
            </li>
            <li>
              Dec 03, 2011:
              Rename sun-resources.xml to glassfish-resources.xml; code formatting
              <em>by Dan Allen</em>
            </li>
            <li>
              Nov 29, 2011:
              Improved jpa tutorial and adjusted it to the arquillian-showcase
              <em>by Bartosz Majsak</em>
            </li>
            <li>
              Nov 13, 2011:
              Use correct styling for console output
              <em>by Dan Allen</em>
            </li>
            <li>
              Nov 13, 2011:
              Update version of glassfish server and adapter
              <em>by Dan Allen</em>
            </li>
            <li>
              Nov 04, 2011:
              Add changelog to guides, revert to static author list
              <em>by Dan Allen</em>
            </li>
            <li>
              Oct 26, 2011:
              Add page_authors(page) method to awestruct::extension::guide
              <em>by Aslak Knutsen</em>
            </li>
            <li>
              Oct 26, 2011:
              Style console output and file tree; fix link
              <em>by Dan Allen</em>
            </li>
            <li>
              Oct 25, 2011:
              Move guide header wrapper into extension; notes
              <em>by Dan Allen</em>
            </li>
            <li>
              Oct 24, 2011:
              Change directory structure to nested list
              <em>by Dan Allen</em>
            </li>
            <li>
              Oct 16, 2011:
              New guides, fix to guide toc, ref doc links, notes
              <em>by Dan Allen</em>
            </li>
          </ul>
          <p>
            <a href="https://github.com/arquillian/arquillian.github.com/commits/develop/guides/testing_java_persistence.textile">See full history &raquo;</a>
          </p>
        </div>
        <div id="sidebar">
          <div id="toc">
            <h3 class="chapter_header">Chapters</h3>
            <ol class="chapters">
              <li>
                <a href="#assumptions" id="assumptions_link">Assumptions</a>
              </li>
              <li>
                <a href="#purpose" id="purpose_link">Purpose</a>
              </li>
              <li>
                <a href="#project_structure" id="project_structure_link">Project Structure</a>
              </li>
              <li>
                <a href="#write_the_test" id="write_the_test_link">Write the Test</a>
              </li>
              <li>
                <a href="#setup_persistence" id="setup_persistence_link">Setup Persistence</a>
              </li>
              <li>
                <a href="#prep_the_test_glassfish" id="prep_the_test_glassfish_link">Prep the Test (GlassFish)</a>
              </li>
              <li>
                <a href="#run_the_test" id="run_the_test_link">Run the Test</a>
              </li>
              <li>
                <a href="#run_the_test_jboss_as" id="run_the_test_jboss_as_link">Run the Test (JBoss AS)</a>
              </li>
              <li>
                <a href="#share" id="share_link">Share the Knowledge</a>
              </li>
            </ol>
          </div>
        </div>
        <script>
          $(window).load(function() { activateScrollingToc(['assumptions', 'purpose', 'project_structure', 'write_the_test', 'setup_persistence', 'prep_the_test_glassfish', 'run_the_test', 'run_the_test_jboss_as', 'share']) })
        </script>
      </div>
    </div>
    <footer>
      <div class="container">
        <div class="project">
          <img src="/images/arquillian_logo_200px.png" />
          <p class="bottom">
            &#169;
            Copyright 2009-2012 Red Hat, Inc.
            <br />
            <i class="icon icon-fire"></i>
            Baked by <a href="http://awestruct.org">Awestruct</a>.
            <br />
            <i class="icon icon-share-alt"></i>
            Website and docs licensed as <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
            <br />
            Code released under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>.
          </p>
        </div>
        <div class="footer-nav">
          <h4>Learn</h4>
          <ul>
            <li>
              <a href="/invasion">Mission</a>
            </li>
            <li>
              <a href="/features">Features</a>
            </li>
            <li>
              <a href="/guides">Guides</a>
            </li>
            <li>
              <a href="https://docs.jboss.org/author/display/ARQ/Reference+Guide">Manual</a>
            </li>
            <li>
              <a href="http://community.jboss.org/en/arquillian/faq">FAQs</a>
            </li>
          </ul>
        </div>
        <div class="footer-nav">
          <h4>Get Involved</h4>
          <ul>
            <li>
              <a href="http://community.jboss.org/en/arquillian?view=discussions">Forums</a>
            </li>
            <li>
              <a href="https://issues.jboss.org/browse/ARQ">Issue Tracker</a>
            </li>
            <li>
              <a href="https://github.com/arquillian">Source Code</a>
            </li>
            <li>
              <a href="/community/contributors">Contributors</a>
            </li>
            <li>
              <a href="https://commmunity.jboss.org/groups/testing">Testing SIG</a>
            </li>
          </ul>
        </div>
        <div class="sponser">
          <div class="follow-us">
            <h4>Stay Informed</h4>
            <ul>
              <li>
                <a href="https://plus.google.com/100660127586085393031"><img alt="Google+" src="/images/gplus-icon.png" /></a>
              </li>
              <li>
                <a href="https://twitter.com/#!/search/%23arquillian"><img alt="Twitter" src="/images/tw-icon.png" /></a>
              </li>
              <li>
                <a href="http://www.linkedin.com/groups?gid=3120340"><img alt="LinkedIn" src="/images/in-icon.png" /></a>
              </li>
              <li>
                <a href="http://vimeo.com/channels/arquillian"><img alt="Vimeo" src="/images/vimeo-icon.png" /></a>
              </li>
            </ul>
          </div>
          <p>This website is open source! You can also <a href="http://www.seethestats.com/site/arquillian.org">see the stats</a>. If you want to help, <a href="http://github.com/arquillian/arquillian.github.com">fork the project</a> and hack on it.</p>
          <p class="image"><a href="http://jboss.org"><img src="/images/jboss_redhat_branding.png" class="branding" title="Red Hat, Inc." alt="Red Hat, Inc." /></a></p>
          <p>Arquillian is a <a href="http://jboss.org">JBoss Community</a> project and development is sponsored by Red Hat, Inc.</p>
          <p class="bottom"><a href="http://www.redhat.com/legal/legal_statement.html">Terms of Use</a> | <a href="http://www.redhat.com/legal/privacy_statement.html">Privacy Policy</a></p>
        </div>
        <a href="#top" id="toTop">Top</a>
      </div>
    </footer>
    <script type="text/javascript">
      //<![CDATA[
        $(function() {
          prettify();
          activateFooterGravity();
          activateTooltips();
          if (window.location.pathname.search(/^\/(guides\/[^\/]+|blog)(\/|$)/) == 0) {
            activateToTopControl();
          }
        });
      //]]>
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.0.2/bootstrap.min.js"></script>
    <script src="/javascripts/prettify.js"></script>
    <script src="/javascripts/site.js?61d07cd5ab395b6e2b0bbe9c55d084ce1302fc5f"></script>
    <script src="/javascripts/jquery-scroll.js"></script>
    <script src="http://apis.google.com/js/plusone.js"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount','UA-18727998-3']);
    _gaq.push(['_trackPageview']);
    (function() {
     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
  </body>
</html>
