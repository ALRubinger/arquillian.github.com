---
layout: guide-index
---
- page.javascripts = [ '/javascripts/jquery-scroll.js', 'http://apis.google.com/js/plusone.js' ]
#content
  ~ content

- if page.guide
  #sidebar
    #toc
      %h3.chapter_header Chapters
      %ol.chapters
        - for chapter in page.guide.chapters
          %li
            %a{ :id=>"#{chapter.link_id}_link", :href=>"##{chapter.link_id}" }
              =chapter.text

  :javascript
    $(window).load(function() {
      var $toc = $('#toc');
      $toc.localScroll();
      var sections = [ #{page.guide.chapters.map{|x| '\'' + x.link_id + '\''}.join(',')} ];
      var currentSection = false;
      var sectionOffsets = {};
      $.each(sections, function(idx, section) {
        sectionOffsets[section] = $('#' + section).position().top;
      });
      
      var tocMetrics = {
        top: $toc.position().top,
        height: $toc.outerHeight()
      };
      var bottomBumper = $('#guide .two-col').outerHeight() + $('#guide .two-col').offset().top - 25;
      var linkColor = $('#toc a:first').css('color');

      var updateToc = function() {
        var scrollY = $(window).scrollTop();
        positionToc(scrollY);
        highlightSectionInToc(scrollY);
      }

      var positionToc = function(scrollY) {
        if (scrollY > tocMetrics.top) {
          if ($toc.css('position') != 'fixed') {
            $toc.css('position', 'fixed');
          }
          var remainingHeight = bottomBumper - scrollY;
          if (remainingHeight < tocMetrics.height) {
            $toc.css('top', 0 - (tocMetrics.height - remainingHeight));
          }
          else {
            $toc.css('top', 5);
          }
        }
        else {
          if ($toc.css('position') != 'static') {
            $toc.css({position: 'static', top: 0});
          }
        }
      };

      var highlightSectionInToc = function(scrollY) {
        var numSections = sections.length;
        $.each(sections, function(idx, section) {
          if (scrollY > sectionOffsets[section] && (idx == numSections - 1 || scrollY < sectionOffsets[sections[idx + 1]])) {
            if (currentSection != section) {
              if (currentSection) {
                toggleSelection(currentSection, false);
              }
              currentSection = section;
              toggleSelection(currentSection, true);
              return false;
            }
          }
        });
      }

      var toggleSelection = function(section, active) {
        if (active) {
          $('#' + section + '_link').css({fontWeight: 'bold', color: '#333333'});
        }
        else {
          $('#' + currentSection + '_link').css({fontWeight: 'normal', color: linkColor});
        }
      }

      updateToc();
      $(window).scroll(updateToc);
    });
